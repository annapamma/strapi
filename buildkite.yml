steps:  
  - label: ":docker: Build"
    plugins:    
      - docker-compose#v3.0.3:
          build: buildkite_ci
          image-repository: index.docker.io/ryanmdev/strapi
  - wait
  
  - label: ":straight_ruler: Unit Test"
    commands:
      - 'echo "*** STARTING Lint and Unit Tests `date` ***"'
      - 'yarn run snyk auth "a88a53a7-63bb-43f2-a78d-41df1448f757"'
      - 'echo "*** `date` ***"'
      - 'yarn run -s test:snyk'
      - 'echo "*** `date` ***"'
      - 'yarn run -s lint'
      - 'echo "*** `date` ***"'
      - 'yarn run -s test:unit'
      - 'echo "*** `date` ***"'
      - 'yarn run -s test:front'
      - 'echo "*** FINISHED Lint and Unit Tests `date` ***"'
    plugins:
      - docker-compose#v3.0.3:
          run: buildkite_ci
  
  # - label: 'Kitchen Sink'
    # command: bash ./ci.sh
    # commands:           
        # - 'yarn setup'
#       - 'echo "*** STARTING Lint and Unit Tests `date` ***"'
#       - 'yarn run snyk auth "a88a53a7-63bb-43f2-a78d-41df1448f757"'
#       - 'echo "*** `date` ***"'
#       - 'yarn run -s test:snyk'
#       - 'echo "*** `date` ***"'
#       - 'yarn run -s lint'
#       - 'echo "*** `date` ***"'
#       - 'yarn run -s test:unit'
#       - 'echo "*** `date` ***"'
#       - 'yarn run -s test:front'
#       - 'echo "*** FINISHED Lint and Unit Tests `date` ***"'

#       # Postgres
  - label: ":mag: Postgres Tests"
    commands:
      - 'echo "*** STARTING Postgres Tests `date` ***"'
      - 'apt-get update && apt-get install -y postgresql-client'
      - 'echo "*** `date` ***"'
      - 'psql -c "create database strapi_test;" -U postgres -h postgres -p 5432'
      - 'echo "*** `date` ***"'      
      - 'yarn run -s test:generate-app -- "--dbclient=postgres --dbhost=postgres --dbport=5432 --dbname=strapi_test --dbusername=postgres --dbpassword="'
      - 'yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337'
      - 'yarn run -s test:e2e'
      - 'echo "*** FINISHED Postgres Tests `date` ***"'
    plugins:
    - docker-compose#v3.0.3:
        run: buildkite_ci
      
#       # MySQL
  - label: ":mag: MySQL Tests"
    commands:
      - 'echo "*** STARTING MySQL Tests `date` ***"'
      - 'apt-get install -y mysql-client'
      - 'yarn run -s test:generate-app -- "--dbclient=mysql --dbhost=mysql --dbport=3306 --dbname=strapi_test --dbusername=ci --dbpassword=passw0rd"'
      - 'yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337'
      - 'yarn run -s test:e2e'
      - 'echo "*** FINISHED MySQL Tests `date` ***"'
    plugins:
    - docker-compose#v3.0.3:
        run: buildkite_ci
      
#       # SQL Lite
  - label: ":mag: Sql Lite Tests"
    commands:
      - 'echo "*** STARTING SQLLite Tests `date` ***"'
      - 'yarn run -s test:generate-app -- "--dbclient=sqlite --dbfile=./tmp/data.db"'
      - 'yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337'
      - 'yarn run -s test:e2e'
      - 'echo "*** FINISHED SQLLite Tests `date` ***"'
    plugins:
    - docker-compose#v3.0.3:
        run: buildkite_ci      
      
#       # Mongo
  - label: ":mag: Mongo Tests"
    commands:
      - 'echo "*** STARTING Mongo Tests `date` ***"'
      - 'yarn run -s test:generate-app -- "--dbclient=mongo --dbhost=mongo --dbport=27017 --dbname=strapi_test --dbusername= --dbpassword="'
      - 'yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337'
      - 'yarn run -s test:e2e'
      - 'echo "*** FINISHED Mongo Tests `date` ***"'
    plugins:
    - docker-compose#v3.0.3:
        run: buildkite_ci   
      
    # plugins:
    #   - docker-compose#v3.0.3:
    #       run: buildkite_ci
    
    # plugins:
    #   docker#v3.2.0:
    #       image: "node:10"