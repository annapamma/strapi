# Run CI/CD jobs in Docker images:
# https://docs.semaphoreci.com/article/127-custom-ci-cd-environment-with-docker
version: v1.0
name: Hello Semaphore
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: semaphoreci/node:10
    - name: postgres
      image: postgres:9.6
      env_vars:
        - name: POSTGRES_PASSWORD
          value: keyboard-cat
    - name: mysql
      image: mysql:5.7
      env_vars:
        - name: MYSQL_ROOT_PASSWORD
          value: rootpw
        - name: MYSQL_DATABASE
          value: strapi_test
        - name: MYSQL_USER
          value: ci
        - name: MYSQL_PASSWORD
          value: passw0rd
blocks:
  - name: Docker-based example
    task:
      jobs:
      - name: Hello
        commands:
          - checkout
          - yarn setup
          - yarn global add -g wait-on
          - yarn run -s lint
          - yarn run -s test:unit
          - yarn run -s test:front
          - apt-get update && apt-get install -y postgresql-client
          - PGPASSWORD="keyboard-cat" createdb -U postgres -h postgres -p 5432 -e strapi_test
          #- psql -c 'create database strapi_test;' -U postgres -h postgres -p 5432
          - yarn run -s test:generate-app -- '--dbclient=postgres --dbhost=postgres --dbport=5432 --dbname=strapi_test --dbusername=postgres --dbpassword=keyboard-cat'
          - yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337
          - yarn run -s test:e2e
          - yarn run -s test:generate-app -- '--dbclient=mysql --dbhost=mysql --dbport=3306 --dbname=strapi_test --dbusername=ci --dbpassword=passw0rd'
          - yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337
          - yarn run -s test:e2e
          
