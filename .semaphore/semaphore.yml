# Run CI/CD jobs in Docker images:
# https://docs.semaphoreci.com/article/127-custom-ci-cd-environment-with-docker
version: v1.0
name: Hello Semaphore
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: semaphoreci/node:10
    - name: db
      image: postgres:9.6
blocks:
  - name: Docker-based example
    task:
      jobs:
      - name: Hello
        commands:
          - checkout
          - yarn setup
          - yarn global add -g wait-on
          - yarn run -s lint
          - yarn run -s test:unit
          - yarn run -s test:front
          - apt-get update && apt-get install -y postgresql-client
          - psql -c 'create database strapi_test;' -U postgres -h postgres -p 5432
          - yarn run -s test:generate-app -- '--dbclient=postgres --dbhost=postgres --dbport=5432 --dbname=strapi_test --dbusername=postgres --dbpassword='
          - yarn run -s test:start-app & ./node_modules/.bin/wait-on http://localhost:1337
          - yarn run -s test:e2e
          
